<app-pull-to-refresh
  [refreshing]="refreshing()"
  (refresh)="onRefresh()">
</app-pull-to-refresh>

<div class="dashboard-container">
  <!-- Header with integrated stats -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>Admin Dashboard</h1>
      <p class="subtitle">Manage organization, users, and system settings</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="onManageUsers()">
        <mat-icon>people</mat-icon>
        Manage Users
      </button>
    </div>
  </div>

  @if (metrics$ | async; as metrics) {
  <!-- Compact Stats Bar -->
  <div class="stats-bar">
    <div class="stat-item">
      <mat-icon>people</mat-icon>
      <span class="stat-value">{{ metrics.activeUsers }}</span>
      <span class="stat-label">Active Users</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item" [class.attention]="metrics.pendingApprovals > 0">
      <mat-icon>pending_actions</mat-icon>
      <span class="stat-value">{{ metrics.pendingApprovals }}</span>
      <span class="stat-label">Pending</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <mat-icon>payments</mat-icon>
      <span class="stat-value">{{ formatCurrency(metrics.monthlySpend) }}</span>
      <span class="stat-label">MTD Spend</span>
      @if (metrics.spendChange > 0) {
        <span class="stat-change" [class.negative]="metrics.spendChangeType === 'negative'" [class.positive]="metrics.spendChangeType === 'positive'">
          {{ metrics.spendChangeType === 'negative' ? '+' : '-' }}{{ metrics.spendChange }}%
        </span>
      }
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <mat-icon>receipt_long</mat-icon>
      <span class="stat-value">{{ metrics.monthlyExpenseCount }}</span>
      <span class="stat-label">Expenses</span>
    </div>
  </div>

  <!-- Analytics Section -->
  <div class="analytics-section">
    <div class="section-header">
      <h2><mat-icon>analytics</mat-icon> Organization Analytics</h2>
    </div>

    <div class="charts-row">
      <!-- Expense Trend -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <mat-icon>show_chart</mat-icon>
            <span>Expense Trend</span>
          </div>
          <span class="chart-period">Last 6 Months</span>
        </div>
        <div class="chart-body">
          @if (expenseTrendData$ | async; as trendData) {
            @if (hasTrendData(trendData)) {
              <ngx-charts-line-chart
                [results]="trendData"
                [scheme]="lineChartColorScheme"
                [xAxis]="true"
                [yAxis]="true"
                [showXAxisLabel]="false"
                [showYAxisLabel]="false"
                [autoScale]="true"
                [gradient]="true"
                [animations]="false">
              </ngx-charts-line-chart>
            } @else {
              <div class="chart-empty">
                <mat-icon>show_chart</mat-icon>
                <span>No expense data yet</span>
              </div>
            }
          }
        </div>
      </div>

      <!-- Category Breakdown -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <mat-icon>donut_large</mat-icon>
            <span>By Category</span>
          </div>
          <span class="chart-period">This Month</span>
        </div>
        <div class="chart-body">
          @if (categorySpendData$ | async; as categoryData) {
            @if (categoryData.length > 0) {
              <ngx-charts-pie-chart
                [results]="categoryData"
                [scheme]="chartColorScheme"
                [legend]="true"
                [legendPosition]="legendPosition"
                [labels]="false"
                [doughnut]="true"
                [gradient]="true"
                [animations]="false">
              </ngx-charts-pie-chart>
            } @else {
              <div class="chart-empty">
                <mat-icon>pie_chart_outline</mat-icon>
                <span>No spend data this month</span>
              </div>
            }
          }
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Two Column Layout: Top Vendors & Top Spenders -->
  <div class="content-grid">
    <!-- Top Vendors -->
    <div class="activity-section">
      <div class="section-header">
        <h2><mat-icon>store</mat-icon> Top Vendors</h2>
        <span class="period-badge">This Month</span>
      </div>

      @if (topVendors$ | async; as vendors) {
        @if (vendors.length > 0) {
          <div class="ranking-list">
            @for (vendor of vendors; track vendor.name; let i = $index) {
              <div class="ranking-row">
                <div class="rank-badge">{{ i + 1 }}</div>
                <div class="ranking-info">
                  <span class="ranking-name">{{ vendor.name }}</span>
                  <span class="ranking-meta">{{ vendor.count }} expenses</span>
                </div>
                <div class="ranking-amount">{{ formatCurrency(vendor.amount) }}</div>
              </div>
            }
          </div>
        } @else {
          <app-empty-state
            icon="store"
            title="No Vendors Yet"
            message="Vendor data will appear here when expenses are submitted">
          </app-empty-state>
        }
      }
    </div>

    <!-- Top Spenders -->
    <div class="activity-section">
      <div class="section-header">
        <h2><mat-icon>person</mat-icon> Top Spenders</h2>
        <span class="period-badge">This Month</span>
      </div>

      @if (topSpenders$ | async; as spenders) {
        @if (spenders.length > 0) {
          <div class="ranking-list">
            @for (spender of spenders; track spender.email; let i = $index) {
              <div class="ranking-row">
                <div class="rank-badge">{{ i + 1 }}</div>
                <div class="ranking-info">
                  <span class="ranking-name">{{ spender.name }}</span>
                  <span class="ranking-meta">{{ spender.count }} expenses</span>
                </div>
                <div class="ranking-amount">{{ formatCurrency(spender.amount) }}</div>
              </div>
            }
          </div>
        } @else {
          <app-empty-state
            icon="person"
            title="No Spenders Yet"
            message="Spender data will appear here when expenses are submitted">
          </app-empty-state>
        }
      }
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="actions-section">
    <div class="section-header">
      <h2><mat-icon>flash_on</mat-icon> Quick Actions</h2>
    </div>

    <div class="action-grid">
      <button mat-raised-button class="action-card" (click)="onManageUsers()">
        <mat-icon>people</mat-icon>
        <div class="action-label">User Management</div>
        <div class="action-desc">Invite users, manage roles</div>
      </button>

      <button mat-raised-button class="action-card" (click)="onViewApprovals()">
        <mat-icon>task_alt</mat-icon>
        <div class="action-label">Approvals Queue</div>
        <div class="action-desc">Review pending expenses</div>
      </button>

      <button mat-raised-button class="action-card" (click)="onViewFinance()">
        <mat-icon>account_balance</mat-icon>
        <div class="action-label">Finance Dashboard</div>
        <div class="action-desc">View financial reports</div>
      </button>

      <button mat-raised-button class="action-card" (click)="onViewExpenses()">
        <mat-icon>receipt_long</mat-icon>
        <div class="action-label">All Expenses</div>
        <div class="action-desc">Browse all expenses</div>
      </button>
    </div>
  </div>
</div>
