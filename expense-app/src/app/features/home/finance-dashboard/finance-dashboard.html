<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>Finance Dashboard</h1>
      <p class="subtitle">Manage reimbursements and track company spending</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="onViewApprovals()">
        <mat-icon>task_alt</mat-icon>
        Review Queue
      </button>
    </div>
  </div>

  @if (metrics$ | async; as metrics) {
  <!-- Compact Stats Bar -->
  <div class="stats-bar">
    <div class="stat-item" [class.attention]="metrics.pendingApprovals > 0">
      <mat-icon>pending_actions</mat-icon>
      <span class="stat-value">{{ metrics.pendingApprovals }}</span>
      <span class="stat-label">Pending</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <mat-icon>payments</mat-icon>
      <span class="stat-value">{{ formatCurrency(metrics.reimbursementsDue) }}</span>
      <span class="stat-label">Due</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <mat-icon>trending_up</mat-icon>
      <span class="stat-value">{{ formatCurrency(metrics.monthToDateSpend) }}</span>
      <span class="stat-label">MTD Spend</span>
      @if (metrics.spendChange > 0) {
        <span class="stat-change" [class.negative]="metrics.spendChangeType === 'negative'" [class.positive]="metrics.spendChangeType === 'positive'">
          {{ metrics.spendChangeType === 'negative' ? '+' : '-' }}{{ metrics.spendChange }}%
        </span>
      }
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item" [class.flagged]="metrics.flaggedExpenses > 0">
      <mat-icon>flag</mat-icon>
      <span class="stat-value">{{ metrics.flaggedExpenses }}</span>
      <span class="stat-label">Violations</span>
    </div>
  </div>

  <!-- Analytics Section -->
  <div class="analytics-section">
    <div class="section-header">
      <h2><mat-icon>analytics</mat-icon> Financial Analytics</h2>
    </div>

    <div class="charts-row">
      <!-- Spending by Category -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <mat-icon>donut_large</mat-icon>
            <span>Spend by Category</span>
          </div>
          <span class="chart-period">This Month</span>
        </div>
        <div class="chart-body">
          @if (categorySpendData$ | async; as categoryData) {
            @if (categoryData.length > 0) {
              <ngx-charts-pie-chart
                [results]="categoryData"
                [scheme]="pieColorScheme"
                [legend]="true"
                [legendPosition]="legendPosition"
                [labels]="false"
                [doughnut]="true"
                [gradient]="true"
                [animations]="true">
              </ngx-charts-pie-chart>
            } @else {
              <div class="chart-empty">
                <mat-icon>pie_chart_outline</mat-icon>
                <span>No expenses this month</span>
              </div>
            }
          }
        </div>
      </div>

      <!-- Approval/Reimbursement Trend -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <mat-icon>show_chart</mat-icon>
            <span>Reimbursement Trend</span>
          </div>
          <span class="chart-period">Last 6 Months</span>
        </div>
        <div class="chart-body">
          @if (spendTrendData$ | async; as trendData) {
            @if (hasTrendData(trendData)) {
              <ngx-charts-line-chart
                [results]="trendData"
                [scheme]="lineChartColorScheme"
                [xAxis]="true"
                [yAxis]="true"
                [showXAxisLabel]="false"
                [showYAxisLabel]="false"
                [legend]="true"
                [legendPosition]="legendPosition"
                [autoScale]="true"
                [gradient]="true"
                [animations]="true">
              </ngx-charts-line-chart>
            } @else {
              <div class="chart-empty">
                <mat-icon>trending_up</mat-icon>
                <span>No historical data yet</span>
              </div>
            }
          }
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Two Column Layout: Pending & Recent Activity -->
  <div class="content-grid">
    <!-- Pending Approvals -->
    <div class="activity-section">
      <div class="section-header">
        <h2><mat-icon>pending_actions</mat-icon> Pending Review</h2>
        <button mat-button color="primary" (click)="onViewApprovals()">View All</button>
      </div>

      @if (pendingApprovals$ | async; as approvals) {
        @if (approvals.length > 0) {
          <div class="expense-list">
            @for (expense of approvals; track expense.id) {
              <div class="expense-row" (click)="onViewExpense(expense)">
                <div class="expense-icon user-icon">
                  <mat-icon>account_circle</mat-icon>
                </div>
                <div class="expense-info">
                  <span class="submitter">{{ getUserName(expense) }}</span>
                  <span class="merchant">{{ expense.merchant || 'No merchant' }}</span>
                </div>
                <div class="expense-amount">{{ formatCurrency(expense.amount) }}</div>
                <div class="expense-actions">
                  <button mat-button color="primary" (click)="onViewExpense(expense)" title="Review expense details">
                    <mat-icon>open_in_new</mat-icon>
                    Review
                  </button>
                </div>
              </div>
            }
          </div>
        } @else {
          <app-empty-state
            icon="check_circle"
            title="All Caught Up"
            message="No expenses pending review">
          </app-empty-state>
        }
      }
    </div>

    <!-- Recent Activity -->
    <div class="activity-section">
      <div class="section-header">
        <h2><mat-icon>history</mat-icon> Recent Activity</h2>
        <button mat-button color="primary" routerLink="/expenses">View All</button>
      </div>

      @if (recentActivity$ | async; as expenses) {
        @if (expenses.length > 0) {
          <div class="expense-list">
            @for (expense of expenses; track expense.id) {
              <div class="expense-row" (click)="onViewExpense(expense)">
                <div class="expense-icon">
                  <mat-icon>receipt</mat-icon>
                </div>
                <div class="expense-info">
                  <span class="merchant">{{ expense.merchant || 'No merchant' }}</span>
                  <span class="date">{{ getUserName(expense) }} - {{ formatDate(expense.expense_date) }}</span>
                </div>
                <div class="expense-amount">{{ formatCurrency(expense.amount) }}</div>
                <app-status-badge [status]="mapStatus(expense.status)" size="small"></app-status-badge>
              </div>
            }
          </div>
        } @else {
          <app-empty-state
            icon="history"
            title="No Recent Activity"
            message="Recent approvals and reimbursements will appear here">
          </app-empty-state>
        }
      }
    </div>
  </div>
</div>
