<div class="jensify-container-sm">
  <mat-card class="jensify-card jensify-animate-slide-up">
    <mat-card-header>
      <mat-card-title>New Expense</mat-card-title>
      <mat-card-subtitle *ngIf="receiptId">Linked to Receipt: {{ receiptId }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="jensify-receipt-toolbar">
        <button mat-flat-button color="primary" type="button" (click)="openAttachDialog()" class="jensify-button">
          <mat-icon>attach_file</mat-icon>
          {{ attachedReceipt ? 'Change receipt' : 'Attach receipt' }}
        </button>
      </div>

      <div class="jensify-attached-receipt" *ngIf="attachedReceipt">
        <div class="jensify-receipt-info">
          <mat-icon>description</mat-icon>
          <div>
            <p class="jensify-receipt-name">{{ attachedReceipt.file_name }}</p>
            <p class="jensify-receipt-meta">{{ attachedReceipt.file_type }} Â· {{ (attachedReceipt.file_size / 1024) | number:'1.0-0' }} KB</p>
          </div>
        </div>
        <div class="jensify-receipt-actions">
          <button mat-button type="button" (click)="viewAttachedReceipt()" class="jensify-button">View</button>
          <button mat-button color="warn" type="button" (click)="removeAttachedReceipt()" class="jensify-button">Remove</button>
        </div>
      </div>

      <div class="jensify-smartscan-status" [ngClass]="smartScanStatus" *ngIf="smartScanLabel as label">
        <mat-icon>{{ smartScanStatus === 'completed' ? 'check_circle' : smartScanStatus === 'failed' ? 'error' : 'autorenew' }}</mat-icon>
        <div>
          <p class="jensify-status-title">{{ label }}</p>
          <p class="jensify-status-hint" *ngIf="smartScanStatus === 'pending' || smartScanStatus === 'processing'">
            We'll alert you when extraction finishes so you can review the auto-filled fields.
          </p>
          <p class="jensify-status-hint" *ngIf="smartScanStatus === 'completed'">
            Details were pulled from the receipt. Double-check before submitting.
          </p>
          <p class="jensify-status-hint" *ngIf="smartScanStatus === 'failed'">
            SmartScan couldn't read this receipt. Please fill fields manually.
          </p>
        </div>
      </div>

      <!-- Split Suggestion Banner -->
      <div class="jensify-split-suggestion" *ngIf="showSplitSuggestion()">
        <div class="split-suggestion-header">
          <mat-icon>call_split</mat-icon>
          <div class="split-suggestion-content">
            <p class="split-suggestion-title">Multiple expense types detected</p>
            <p class="split-suggestion-hint">
              This receipt appears to contain items from different categories:
            </p>
            <div class="detected-categories">
              <mat-chip-set>
                @for (category of uniqueCategories(); track category) {
                  <mat-chip [highlighted]="true">{{ category }}</mat-chip>
                }
              </mat-chip-set>
            </div>
          </div>
          <button mat-icon-button
                  (click)="dismissSplitSuggestion()"
                  matTooltip="Dismiss suggestion"
                  class="dismiss-btn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="detected-items">
          <p class="items-label">Detected line items:</p>
          @for (item of detectedLineItems(); track item.description) {
            <div class="detected-item">
              <span class="item-description">{{ item.description }}</span>
              <span class="item-amount">{{ formatCurrency(item.amount) }}</span>
              <mat-chip class="item-category" [matTooltip]="'Confidence: ' + (item.confidence * 100 | number:'1.0-0') + '%'">
                {{ item.suggestedCategory }}
              </mat-chip>
            </div>
          }
        </div>
        <div class="split-suggestion-actions">
          <button mat-stroked-button type="button" (click)="dismissSplitSuggestion()">
            Keep as single expense
          </button>
          <button mat-flat-button color="primary" type="button" (click)="openSplitDialog()">
            <mat-icon>call_split</mat-icon>
            Split expense
          </button>
        </div>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="jensify-form">
        <div class="jensify-message-error" *ngIf="errorMessage">
          <mat-icon>error</mat-icon>
          <span>{{ errorMessage }}</span>
        </div>
        <div class="jensify-message-success" *ngIf="successMessage">
          <mat-icon>check_circle</mat-icon>
          <span>{{ successMessage }}</span>
        </div>

        <mat-form-field appearance="fill" floatLabel="always" class="jensify-full-width">
          <mat-label>Merchant</mat-label>
          <input matInput formControlName="merchant" />
        </mat-form-field>

        <mat-form-field appearance="fill" floatLabel="always" class="jensify-full-width">
          <mat-label>Amount (USD)</mat-label>
          <input matInput type="number" step="0.01" formControlName="amount" />
        </mat-form-field>

        <mat-form-field appearance="fill" floatLabel="always" class="jensify-full-width">
          <mat-label>Category</mat-label>
          <mat-select formControlName="category">
            <mat-option *ngFor="let c of categories; trackBy: trackByCategory" [value]="c">{{ c }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" floatLabel="always" class="jensify-full-width">
          <mat-label>Date</mat-label>
          <input matInput type="date" formControlName="expense_date" />
        </mat-form-field>

        <mat-form-field appearance="fill" floatLabel="always" class="jensify-full-width">
          <mat-label>Notes</mat-label>
          <input matInput formControlName="notes" />
        </mat-form-field>

        <div class="jensify-form-actions">
          <a mat-stroked-button routerLink="/expenses" class="jensify-button">Cancel</a>
          <button mat-raised-button color="primary" [disabled]="loading" class="jensify-button">Save</button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
