<div class="expense-list-container">
  <!-- Compact Header -->
  <div class="expense-header">
    <div class="header-left">
      <h1>My Expenses</h1>
      <div class="header-stats">
        <span class="stat">{{ totalCount() }} {{ totalCount() === 1 ? 'expense' : 'expenses' }}</span>
        <span class="stat-divider">•</span>
        <span class="stat">{{ formatCurrency(totalAmount()) }}</span>
        @if (draftExpenses().length > 0) {
          <span class="stat-divider">•</span>
          <span class="stat draft-count">{{ draftExpenses().length }} {{ draftExpenses().length === 1 ? 'draft' : 'drafts' }}</span>
        }
      </div>
    </div>
    <button
      mat-flat-button
      color="primary"
      (click)="exportToCSV()"
      [disabled]="filteredExpenses().length === 0">
      <mat-icon>download</mat-icon>
      Export
    </button>
  </div>

  <!-- Batch Action Bar (appears when expenses are selected) -->
  @if (selectedCount() > 0) {
    <div class="batch-action-bar">
      <div class="batch-left">
        <mat-checkbox
          [checked]="allDraftsSelected()"
          [indeterminate]="selectedCount() > 0 && !allDraftsSelected()"
          (change)="toggleSelectAll()">
        </mat-checkbox>
        <span class="selection-count">
          {{ selectedCount() }} selected
        </span>
      </div>
      <div class="batch-actions">
        <button mat-button (click)="clearSelection()">Clear</button>
        <button
          mat-flat-button
          color="primary"
          (click)="addToReport()"
          [disabled]="submittingBatch()">
          <mat-icon>folder_open</mat-icon>
          Add to Report
        </button>
      </div>
    </div>
  }

  <!-- Compact Filter Bar -->
  <div class="filter-bar">
    <!-- Status Chips -->
    <div class="status-chips">
      @for (option of statusOptions; track option.value) {
        <button
          class="status-chip"
          [class.active]="selectedStatus() === option.value"
          (click)="setStatusFilter(option.value)">
          {{ option.label }}
        </button>
      }
    </div>

    <!-- Search Input -->
    <div class="search-box">
      <mat-icon>search</mat-icon>
      <input
        type="text"
        placeholder="Search merchants..."
        [ngModel]="searchQuery()"
        (ngModelChange)="searchQuery.set($event)">
    </div>

    <!-- Filter Toggle -->
    <button
      class="filter-toggle"
      [class.active]="showAdvancedFilters"
      (click)="showAdvancedFilters = !showAdvancedFilters">
      <mat-icon>tune</mat-icon>
      <span>Filters</span>
      @if (activeFilterCount() > 0) {
        <span class="filter-badge">{{ activeFilterCount() }}</span>
      }
    </button>
  </div>

  <!-- Advanced Filters (Collapsible) -->
  @if (showAdvancedFilters) {
    <div class="advanced-filters">
      <div class="filter-group">
        <label for="category-filter">Category</label>
        <mat-select id="category-filter" [value]="selectedCategory()" (selectionChange)="selectedCategory.set($event.value)">
          @for (option of categoryOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </div>

      <div class="filter-group">
        <label for="date-from-filter">From</label>
        <input
          id="date-from-filter"
          type="date"
          [ngModel]="dateFrom() | date:'yyyy-MM-dd'"
          (ngModelChange)="setDateFrom($event)">
      </div>

      <div class="filter-group">
        <label for="date-to-filter">To</label>
        <input
          id="date-to-filter"
          type="date"
          [ngModel]="dateTo() | date:'yyyy-MM-dd'"
          (ngModelChange)="setDateTo($event)">
      </div>

      <div class="filter-group">
        <label for="min-amount-filter">Min $</label>
        <input
          id="min-amount-filter"
          type="number"
          min="0"
          step="0.01"
          placeholder="0.00"
          [ngModel]="minAmount()"
          (ngModelChange)="minAmount.set($event)">
      </div>

      <div class="filter-group">
        <label for="max-amount-filter">Max $</label>
        <input
          id="max-amount-filter"
          type="number"
          min="0"
          step="0.01"
          placeholder="0.00"
          [ngModel]="maxAmount()"
          (ngModelChange)="maxAmount.set($event)">
      </div>

      <button class="clear-btn" (click)="clearFilters()">
        <mat-icon>clear</mat-icon>
        Clear
      </button>
    </div>
  }

  <!-- Loading State -->
  @if (loading()) {
    <app-loading-skeleton />
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <mat-card class="jensify-card error-card">
      <mat-icon>error</mat-icon>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="loadExpenses()">Retry</button>
    </mat-card>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && filteredExpenses().length === 0 && expenses().length === 0) {
    <app-empty-state
      icon="receipt_long"
      title="No expenses yet"
      message="Upload your first receipt to get started tracking expenses."
      actionLabel="Upload Receipt"
      actionIcon="upload">
    </app-empty-state>
  }

  <!-- No Results Empty State -->
  @if (!loading() && !error() && filteredExpenses().length === 0 && expenses().length > 0) {
    <app-empty-state
      icon="filter_alt_off"
      title="No expenses match your filters"
      message="Try adjusting your filter criteria to see more results."
      actionLabel="Clear Filters"
      actionIcon="clear">
    </app-empty-state>
  }

  <!-- Expense Cards List with Virtual Scrolling -->
  @if (!loading() && !error() && filteredExpenses().length > 0) {
    <cdk-virtual-scroll-viewport
      itemSize="220"
      class="jensify-queue-viewport">
      <div class="jensify-expense-cards">
        <mat-card
          *cdkVirtualFor="let expense of filteredExpenses(); trackBy: trackByExpenseId"
          class="jensify-card jensify-expense-card"
          [class.selected]="isSelected(expense.id)">
          <div class="jensify-expense-card-content">
            <!-- Card Header Row -->
            <div class="jensify-card-header-row">
              <!-- Selection Checkbox (only for draft expenses) -->
              @if (expense.status === ExpenseStatus.DRAFT) {
                <mat-checkbox
                  class="jensify-card-checkbox"
                  [checked]="isSelected(expense.id)"
                  (change)="toggleSelection(expense)"
                  (click)="$event.stopPropagation()">
                </mat-checkbox>
              }

              <!-- Receipt Thumbnail -->
              <div class="jensify-thumbnail-container">
                @if (getReceiptThumbnail(expense)) {
                  <img
                    [src]="getReceiptThumbnail(expense)"
                    [alt]="expense.merchant + ' receipt'"
                    loading="lazy">
                  @if (hasMultipleReceipts(expense)) {
                    <div class="jensify-receipt-count-badge">
                      <mat-icon>collections</mat-icon>
                      <span>{{ getReceiptCount(expense) }}</span>
                    </div>
                  }
                } @else {
                  <div class="jensify-thumbnail-placeholder">
                    <mat-icon>receipt</mat-icon>
                  </div>
                }
              </div>

              <!-- Status Badge -->
              <app-status-badge [status]="getStatusBadge(expense.status)" />
            </div>

            <!-- Merchant & Amount Row -->
            <div class="jensify-card-main">
              <h3 class="jensify-merchant-name">{{ expense.merchant }}</h3>
              <span class="jensify-expense-amount">{{ formatCurrency(expense.amount) }}</span>
            </div>

            <!-- Meta Info -->
            <div class="jensify-expense-meta">
              <span class="jensify-meta-item">{{ formatDate(expense.expense_date) }}</span>
              <span class="jensify-meta-divider">•</span>
              <span class="jensify-meta-item">{{ expense.category }}</span>
              @if (expense.report_id) {
                <span class="jensify-meta-divider">•</span>
                <span class="jensify-meta-item jensify-in-report">In report</span>
              }
            </div>

            @if (expense.notes) {
              <p class="jensify-expense-notes">{{ expense.notes }}</p>
            }
          </div>

            @if (hasViolations(expense)) {
            <div class="jensify-violation-banner">
              <mat-icon>report</mat-icon>
              <div>
                <p class="jensify-violation-text">Needs attention</p>
                <p class="jensify-subtext jensify-mb-0">
                  {{ expense.policy_violations[0].message }}
                </p>
                @if (expense.policy_violations.length > 1) {
                  <p class="jensify-subtext jensify-mb-0 jensify-mt-xs jensify-text-italic">
                    +{{ expense.policy_violations.length - 1 }} more issue(s)
                  </p>
                }
              </div>
              <button mat-stroked-button color="warn" (click)="fixViolations(expense)">
                Fix Violations
              </button>
            </div>
          }

          <!-- Card Actions -->
          <div class="jensify-card-actions">
            <button mat-button (click)="viewReceipt(expense)" [disabled]="!expense.receipt">
              <mat-icon>description</mat-icon>
              {{ expense.receipt ? 'View Receipt' : 'No Receipt' }}
            </button>
            <button mat-button (click)="goToDetails(expense)">
              <mat-icon>visibility</mat-icon>
              View Details
            </button>
            @if (expense.status === ExpenseStatus.DRAFT) {
              <button mat-button color="primary" (click)="goToEdit(expense)">
                <mat-icon>edit</mat-icon>
                Edit
              </button>
            }
          </div>
        </mat-card>
      </div>
    </cdk-virtual-scroll-viewport>
  }
</div>
