<div class="jensify-container-sm">
  <mat-card class="jensify-card">
    <mat-card-header>
      <mat-card-title>Upload Receipt</mat-card-title>
      <mat-card-subtitle>Upload receipts for gas, hotels, flights, meals, and other business expenses</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="jensify-message-error">
          <mat-icon>error</mat-icon>
          <span>{{ errorMessage() }}</span>
        </div>
      }

      <!-- Upload Area (shown when no file selected) -->
      @if (!selectedFile() && !isUploading() && !uploadedReceipt()) {
        <div
          class="jensify-drop-zone"
          [class.dragging]="isDragging()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)">

          <mat-icon class="jensify-upload-icon">cloud_upload</mat-icon>
          <p class="jensify-upload-text">Drag and drop your receipt here</p>
          <p class="jensify-upload-subtext">or</p>

          <!-- File Input Buttons -->
          <div class="jensify-button-group">
            <!-- File Picker -->
            <input
              #fileInput
              type="file"
              accept="{{ ALLOWED_EXTENSIONS.join(',') }}"
              (change)="onFileSelected($event)"
              hidden>
            <button
              mat-raised-button
              color="primary"
              class="jensify-button"
              (click)="fileInput.click()">
              <mat-icon>folder_open</mat-icon>
              Choose File
            </button>

            <!-- Camera Capture (Mobile) -->
            <input
              #cameraInput
              type="file"
              accept="image/*"
              capture="environment"
              (change)="onCameraCapture($event)"
              hidden>
            <button
              mat-raised-button
              color="primary"
              class="jensify-button"
              (click)="cameraInput.click()">
              <mat-icon>photo_camera</mat-icon>
              Take Photo
            </button>
          </div>

          <p class="jensify-subtext jensify-mt-md">
            Accepted: JPEG, PNG, PDF â€¢ Max size: 5MB
          </p>
        </div>
      }

      <!-- Preview Area (shown when file selected) -->
      @if (selectedFile() && !isUploading()) {
        <div class="jensify-preview-container">
          <!-- Image Preview -->
          @if (hasPreview()) {
            <div class="jensify-image-preview">
              <img [src]="previewUrl()" alt="Receipt preview" loading="lazy">
            </div>
          }

          <!-- PDF Preview -->
          @if (isPdf()) {
            <div class="jensify-pdf-preview">
              <mat-icon class="jensify-pdf-icon">picture_as_pdf</mat-icon>
              <p>PDF Document</p>
            </div>
          }

          <!-- File Info -->
          <div class="jensify-file-info">
            <div class="jensify-file-details">
              <mat-icon>description</mat-icon>
              <div class="jensify-file-text">
                <p class="jensify-file-name">{{ selectedFile()!.name }}</p>
                <p class="jensify-file-size">{{ getFileSizeLabel() }}</p>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="jensify-action-buttons">
              <button
                mat-button
                color="warn"
                (click)="clearFile()"
                class="jensify-button">
                <mat-icon>delete</mat-icon>
                Remove
              </button>
              <button
                mat-raised-button
                color="primary"
                class="jensify-button"
                [disabled]="!canUpload()"
                (click)="uploadReceipt()">
                <mat-icon>cloud_upload</mat-icon>
                Upload
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Upload Progress -->
      @if (showProgress()) {
        <div class="jensify-loading">
          <mat-icon class="jensify-upload-spinner">cloud_upload</mat-icon>
          <p class="jensify-upload-status">Uploading receipt...</p>
          <mat-progress-bar
            mode="determinate"
            [value]="uploadProgress()">
          </mat-progress-bar>
          <p class="jensify-progress-text">{{ uploadProgress() }}%</p>
        </div>
      }

      <!-- Success State -->
      @if (uploadedReceipt() && !isUploading()) {
        <div class="jensify-success-container">
          <mat-icon class="jensify-success-icon">check_circle</mat-icon>
          <h3>Receipt Uploaded Successfully!</h3>

          <!-- OCR Processing Status -->
          @if (ocrProcessing()) {
            <div class="jensify-ocr-status">
              <mat-spinner diameter="24"></mat-spinner>
              <p>SmartScan is extracting receipt details...</p>
            </div>
          }

          <!-- OCR Results (Editable) -->
          @if (ocrCompleted()) {
            <div class="jensify-ocr-results">
              <mat-icon>auto_awesome</mat-icon>
              <h4>SmartScan Results</h4>
              <p class="jensify-edit-hint">Review and edit if needed</p>

              <div class="jensify-extracted-data">
                <mat-form-field appearance="fill" class="jensify-ocr-field">
                  <mat-label>Merchant</mat-label>
                  <input matInput
                    [ngModel]="extractedMerchant()"
                    (ngModelChange)="extractedMerchant.set($event)"
                    placeholder="Merchant name">
                </mat-form-field>

                <mat-form-field appearance="fill" class="jensify-ocr-field">
                  <mat-label>Amount</mat-label>
                  <span matPrefix>$</span>
                  <input matInput
                    type="number"
                    step="0.01"
                    [ngModel]="extractedAmount()"
                    (ngModelChange)="extractedAmount.set($event)"
                    placeholder="0.00">
                </mat-form-field>

                <mat-form-field appearance="fill" class="jensify-ocr-field">
                  <mat-label>Date</mat-label>
                  <input matInput
                    [ngModel]="extractedDate()"
                    (ngModelChange)="extractedDate.set($event)"
                    placeholder="YYYY-MM-DD">
                </mat-form-field>

                <mat-form-field appearance="fill" class="jensify-ocr-field">
                  <mat-label>Category</mat-label>
                  <mat-select
                    [ngModel]="extractedCategory()"
                    (ngModelChange)="extractedCategory.set($event)">
                    @for (option of categoryOptions; track option.value) {
                      <mat-option [value]="option.value">{{ option.label }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          }

          <!-- OCR Failed -->
          @if (ocrFailed()) {
            <div class="jensify-ocr-failed">
              <mat-icon>warning</mat-icon>
              <p>SmartScan couldn't extract details. You can enter them manually.</p>
            </div>
          }

          <!-- Next Actions -->
          @if (!ocrProcessing()) {
            <p class="jensify-success-message">What would you like to do next?</p>
            <div class="jensify-action-buttons">
              <button
                mat-stroked-button
                color="primary"
                (click)="resetForAnotherUpload()"
                class="jensify-button">
                <mat-icon>upload</mat-icon>
                Upload Another Receipt
              </button>

              <button
                mat-raised-button
                color="primary"
                (click)="navigateToExpenseForm()"
                class="jensify-button">
                <mat-icon>receipt_long</mat-icon>
                Create Expense Now
              </button>
            </div>
          }
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Help Section -->
  <div class="jensify-help-section">
    <h3>Tips for best results:</h3>
    <ul>
      <li>Ensure the entire receipt is visible and in focus</li>
      <li>Avoid shadows and glare on the receipt</li>
      <li>Capture in good lighting conditions</li>
      <li>Keep the receipt flat and straight</li>
      <li>Accepted: Gas receipts, hotel invoices, flight confirmations, meal receipts, and more</li>
    </ul>
  </div>
</div>
