<div class="announcement-form-container">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-left">
        <button mat-icon-button routerLink="/super-admin/announcements">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div>
          <h1>{{ announcementId() && announcementId() !== 'new' ? 'Edit Announcement' : 'Create Announcement' }}</h1>
          <p class="subtitle">Configure platform-wide user announcements</p>
        </div>
      </div>
      <div class="header-actions">
        <button mat-stroked-button (click)="cancel()">
          Cancel
        </button>
        <button
          mat-flat-button
          color="primary"
          (click)="save()"
          [disabled]="isSaving() || announcementForm.invalid"
        >
          <mat-icon>save</mat-icon>
          Save Announcement
        </button>
      </div>
    </div>
  </header>

  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading announcement...</p>
    </div>
  } @else {
    <div class="form-layout">
      <!-- Main Form -->
      <div class="form-section">
        <form [formGroup]="announcementForm">
          <!-- Content -->
          <mat-card class="form-card">
            <div class="card-header">
              <div class="header-icon">
                <mat-icon>description</mat-icon>
              </div>
              <div>
                <h2>Content</h2>
                <p>Announcement title and message</p>
              </div>
            </div>
            <mat-divider></mat-divider>

            <div class="card-content">
              <mat-form-field class="full-width">
                <mat-label>Title</mat-label>
                <input
                  matInput
                  formControlName="title"
                  placeholder="New Feature: GPS Tracking"
                  maxlength="100"
                />
                @if (announcementForm.get('title')?.hasError('required')) {
                  <mat-error>Title is required</mat-error>
                }
                <mat-hint align="end">
                  {{ announcementForm.get('title')?.value?.length || 0 }}/100
                </mat-hint>
              </mat-form-field>

              <mat-form-field class="full-width">
                <mat-label>Message</mat-label>
                <textarea
                  matInput
                  formControlName="message"
                  rows="4"
                  maxlength="500"
                  placeholder="We have launched real-time GPS tracking for mileage expenses!"
                ></textarea>
                @if (announcementForm.get('message')?.hasError('required')) {
                  <mat-error>Message is required</mat-error>
                }
                <mat-hint align="end">
                  {{ announcementForm.get('message')?.value?.length || 0 }}/500
                </mat-hint>
              </mat-form-field>
            </div>
          </mat-card>

          <!-- Type & Audience -->
          <mat-card class="form-card">
            <div class="card-header">
              <div class="header-icon type">
                <mat-icon>category</mat-icon>
              </div>
              <div>
                <h2>Type & Audience</h2>
                <p>Configure announcement type and target users</p>
              </div>
            </div>
            <mat-divider></mat-divider>

            <div class="card-content">
              <div class="type-grid">
                @for (type of types; track type.value) {
                  <div
                    class="type-option"
                    [class.selected]="announcementForm.get('type')?.value === type.value"
                    (click)="announcementForm.get('type')?.setValue(type.value)"
                    (keydown.enter)="announcementForm.get('type')?.setValue(type.value)"
                    tabindex="0"
                    role="button"
                    [attr.aria-label]="'Select ' + type.label + ' announcement type'"
                  >
                    <mat-icon [style.color]="type.color">{{ type.icon }}</mat-icon>
                    <span>{{ type.label }}</span>
                  </div>
                }
              </div>

              <mat-form-field class="full-width">
                <mat-label>Target Audience</mat-label>
                <mat-select formControlName="target_audience">
                  @for (audience of audiences; track audience.value) {
                    <mat-option [value]="audience.value">
                      <mat-icon>{{ audience.icon }}</mat-icon>
                      {{ audience.label }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </mat-card>

          <!-- Display Settings -->
          <mat-card class="form-card">
            <div class="card-header">
              <div class="header-icon display">
                <mat-icon>display_settings</mat-icon>
              </div>
              <div>
                <h2>Display Settings</h2>
                <p>Configure how the announcement is shown</p>
              </div>
            </div>
            <mat-divider></mat-divider>

            <div class="card-content">
              <mat-form-field class="full-width">
                <mat-label>Display Location</mat-label>
                <mat-select formControlName="display_location">
                  @for (location of locations; track location.value) {
                    <mat-option [value]="location.value">
                      <div class="location-option">
                        <strong>{{ location.label }}</strong>
                        <span class="location-desc">{{ location.description }}</span>
                      </div>
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <div class="checkbox-row">
                <mat-checkbox formControlName="is_dismissible" color="primary">
                  Allow users to dismiss this announcement
                </mat-checkbox>
              </div>
            </div>
          </mat-card>

          <!-- Schedule -->
          <mat-card class="form-card">
            <div class="card-header">
              <div class="header-icon schedule">
                <mat-icon>schedule</mat-icon>
              </div>
              <div>
                <h2>Schedule</h2>
                <p>Set start and end dates</p>
              </div>
            </div>
            <mat-divider></mat-divider>

            <div class="card-content">
              <mat-form-field class="full-width">
                <mat-label>Start Date & Time</mat-label>
                <input
                  matInput
                  [matDatepicker]="startPicker"
                  formControlName="starts_at"
                />
                <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
                @if (announcementForm.get('starts_at')?.hasError('required')) {
                  <mat-error>Start date is required</mat-error>
                }
              </mat-form-field>

              <div class="checkbox-row">
                <mat-checkbox formControlName="has_end_date" color="primary">
                  Set end date (announcement will automatically expire)
                </mat-checkbox>
              </div>

              @if (announcementForm.get('has_end_date')?.value) {
                <mat-form-field class="full-width">
                  <mat-label>End Date & Time</mat-label>
                  <input
                    matInput
                    [matDatepicker]="endPicker"
                    formControlName="ends_at"
                  />
                  <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
                  <mat-datepicker #endPicker></mat-datepicker>
                  @if (announcementForm.get('ends_at')?.hasError('required')) {
                    <mat-error>End date is required</mat-error>
                  }
                </mat-form-field>
              }
            </div>
          </mat-card>
        </form>
      </div>

      <!-- Preview -->
      <div class="preview-section">
        <mat-card class="preview-card sticky">
          <div class="card-header">
            <div class="header-icon preview">
              <mat-icon>visibility</mat-icon>
            </div>
            <div>
              <h2>Preview</h2>
              <p>How users will see it</p>
            </div>
          </div>
          <mat-divider></mat-divider>

          <div class="preview-content">
            @if (announcementForm.get('display_location')?.value === 'banner') {
              <div class="preview-banner" [class]="'type-' + announcementForm.get('type')?.value">
                <mat-icon>{{ selectedType()?.icon }}</mat-icon>
                <div class="banner-content">
                  <strong>{{ announcementForm.get('title')?.value || 'Announcement Title' }}</strong>
                  <span>{{ announcementForm.get('message')?.value || 'Your announcement message will appear here...' }}</span>
                </div>
                @if (announcementForm.get('is_dismissible')?.value) {
                  <button mat-icon-button class="dismiss-btn">
                    <mat-icon>close</mat-icon>
                  </button>
                }
              </div>
            }

            @if (announcementForm.get('display_location')?.value === 'modal') {
              <div class="preview-modal" [class]="'type-' + announcementForm.get('type')?.value">
                <div class="modal-header">
                  <mat-icon>{{ selectedType()?.icon }}</mat-icon>
                  <h3>{{ announcementForm.get('title')?.value || 'Announcement Title' }}</h3>
                  @if (announcementForm.get('is_dismissible')?.value) {
                    <button mat-icon-button class="dismiss-btn">
                      <mat-icon>close</mat-icon>
                    </button>
                  }
                </div>
                <div class="modal-body">
                  <p>{{ announcementForm.get('message')?.value || 'Your announcement message will appear here...' }}</p>
                </div>
                <div class="modal-footer">
                  <button mat-flat-button color="primary">Got it</button>
                </div>
              </div>
            }

            @if (announcementForm.get('display_location')?.value === 'toast') {
              <div class="preview-toast" [class]="'type-' + announcementForm.get('type')?.value">
                <mat-icon>{{ selectedType()?.icon }}</mat-icon>
                <div class="toast-content">
                  <strong>{{ announcementForm.get('title')?.value || 'Announcement Title' }}</strong>
                  <span>{{ announcementForm.get('message')?.value || 'Your announcement message...' }}</span>
                </div>
                @if (announcementForm.get('is_dismissible')?.value) {
                  <button mat-icon-button class="dismiss-btn">
                    <mat-icon>close</mat-icon>
                  </button>
                }
              </div>
            }

            <div class="preview-info">
              <mat-icon>info</mat-icon>
              <p>
                This is a preview of how your announcement will appear to
                <strong>{{ getAudienceLabel() }}</strong> users.
              </p>
            </div>
          </div>
        </mat-card>
      </div>
    </div>
  }
</div>
