<div class="jensify-container">
  <!-- Pull to Refresh (mobile only) -->
  <app-pull-to-refresh
    [refreshing]="loading()"
    (refresh)="loadTrips()">
  </app-pull-to-refresh>

  <!-- Header with Summary -->
  <div class="jensify-page-header">
    <div class="jensify-header-content">
      <h1 class="jensify-page-title">Mileage</h1>
      <div class="jensify-summary-metrics">
        <div class="jensify-metric">
          <span class="jensify-metric-value">{{ totalCount() }}</span>
          <span class="jensify-metric-label">{{ totalCount() === 1 ? 'Trip' : 'Trips' }}</span>
        </div>
        <div class="jensify-metric">
          <span class="jensify-metric-value">{{ totalMiles().toFixed(1) }}</span>
          <span class="jensify-metric-label">Total Miles</span>
        </div>
        <div class="jensify-metric">
          <span class="jensify-metric-value">{{ formatCurrency(totalReimbursement()) }}</span>
          <span class="jensify-metric-label">Reimbursement</span>
        </div>
        @if (draftTrips().length > 0) {
          <div class="jensify-metric">
            <span class="jensify-metric-value">{{ draftTrips().length }}</span>
            <span class="jensify-metric-label">{{ draftTrips().length === 1 ? 'Draft' : 'Drafts' }}</span>
          </div>
        }
      </div>
    </div>
    <div class="jensify-header-actions">
      <button
        mat-raised-button
        color="primary"
        class="jensify-button"
        (click)="addNewTrip()">
        <mat-icon>add</mat-icon>
        Add Trip
      </button>
      <button
        mat-flat-button
        color="primary"
        class="jensify-export-btn jensify-button"
        (click)="exportToCSV()"
        [disabled]="filteredTrips().length === 0">
        <mat-icon>download</mat-icon>
        Export
      </button>
    </div>
  </div>

  <!-- Batch Action Bar (appears when trips are selected) -->
  @if (selectedCount() > 0) {
    <mat-card class="jensify-card jensify-batch-action-bar">
      <div class="jensify-batch-content">
        <mat-checkbox
          [checked]="allDraftsSelected()"
          [indeterminate]="selectedCount() > 0 && !allDraftsSelected()"
          (change)="toggleSelectAll()">
        </mat-checkbox>
        <span class="jensify-selection-count">
          {{ selectedCount() }} trip{{ selectedCount() > 1 ? 's' : '' }} selected
        </span>
      </div>
      <div class="jensify-batch-actions">
        <button mat-button (click)="clearSelection()" class="jensify-button">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
        <button
          mat-raised-button
          color="primary"
          class="jensify-button"
          (click)="submitSelected()"
          [disabled]="submittingBatch()">
          <mat-icon>send</mat-icon>
          Submit for Approval
        </button>
      </div>
    </mat-card>
  }

  <!-- Statistics Widget -->
  <app-mileage-stats-widget
    [startDate]="filterState().dateFrom?.toISOString()"
    [endDate]="filterState().dateTo?.toISOString()"
    [showBreakdown]="true">
  </app-mileage-stats-widget>

  <!-- Filters Component -->
  <app-trip-filters
    [filters]="filterState()"
    [showAdvanced]="showAdvancedFilters"
    [activeFilterCount]="activeFilterCount()"
    (filtersChange)="onFiltersChange($event)"
    (toggleAdvanced)="toggleAdvancedFilters()"
    (clearFilters)="clearFilters()">
  </app-trip-filters>

  <!-- Loading State -->
  @if (loading()) {
    <app-loading-skeleton />
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <mat-card class="jensify-card error-card">
      <mat-icon>error</mat-icon>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="loadTrips()">Retry</button>
    </mat-card>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && filteredTrips().length === 0 && trips().length === 0) {
    <app-empty-state
      icon="directions_car"
      title="No trips yet"
      message="Log your first business trip to start tracking mileage reimbursement."
      actionLabel="Add Trip"
      actionIcon="add"
      (actionClick)="addNewTrip()">
    </app-empty-state>
  }

  <!-- No Results Empty State -->
  @if (!loading() && !error() && filteredTrips().length === 0 && trips().length > 0) {
    <app-empty-state
      icon="filter_alt_off"
      title="No trips match your filters"
      message="Try adjusting your filter criteria to see more results."
      actionLabel="Clear Filters"
      actionIcon="clear"
      (actionClick)="clearFilters()">
    </app-empty-state>
  }

  <!-- Trip Cards List with Virtual Scrolling -->
  @if (!loading() && !error() && filteredTrips().length > 0) {
    <cdk-virtual-scroll-viewport
      itemSize="240"
      class="jensify-trip-cards-viewport">
      <div class="jensify-trip-cards">
        <mat-card
          *cdkVirtualFor="let trip of filteredTrips(); trackBy: trackByTripId"
          class="jensify-card jensify-trip-card"
          [class.selected]="isSelected(trip.id)"
          role="article"
          [attr.aria-label]="'Trip on ' + formatDate(trip.trip_date) + ' from ' + trip.origin_address + ' to ' + trip.destination_address + ', ' + trip.total_miles + ' miles, status ' + trip.status + ', reimbursement ' + formatCurrency(trip.reimbursement_amount)">
          <div class="jensify-card-content">
            <!-- Selection Checkbox (only for draft trips) -->
            @if (trip.status === 'draft') {
              <div class="jensify-checkbox-container">
                <mat-checkbox
                  [checked]="isSelected(trip.id)"
                  (change)="toggleSelection(trip)"
                  (click)="$event.stopPropagation()"
                  [attr.aria-label]="'Select trip from ' + trip.origin_address + ' to ' + trip.destination_address">
                </mat-checkbox>
              </div>
            }

            <!-- Trip Icon -->
            <div class="jensify-trip-icon-container">
              <div class="jensify-trip-icon">
                <mat-icon>directions_car</mat-icon>
              </div>
            </div>

            <!-- Trip Details -->
            <div class="jensify-trip-details">
              <div class="jensify-trip-header">
                <div class="jensify-trip-route">
                  <div class="jensify-route-item">
                    <mat-icon class="jensify-route-icon">place</mat-icon>
                    <span class="jensify-address">{{ trip.origin_address }}</span>
                  </div>
                  <mat-icon class="jensify-arrow-icon">arrow_downward</mat-icon>
                  <div class="jensify-route-item">
                    <mat-icon class="jensify-route-icon">location_on</mat-icon>
                    <span class="jensify-address">{{ trip.destination_address }}</span>
                  </div>
                </div>
                <app-status-badge [status]="getStatusBadge(trip.status)" />
              </div>

              <div class="jensify-trip-meta">
                <div class="jensify-meta-item">
                  <mat-icon>event</mat-icon>
                  <span>{{ formatDate(trip.trip_date) }}</span>
                </div>
                <div class="jensify-meta-item">
                  <mat-icon>business_center</mat-icon>
                  <span>{{ trip.category }}</span>
                </div>
                <div class="jensify-meta-item">
                  <mat-icon>description</mat-icon>
                  <span>{{ trip.purpose || '(No purpose)' }}</span>
                </div>
              </div>

              <div class="jensify-trip-mileage-info">
                <div class="jensify-mileage-item">
                  <span class="jensify-mileage-label">Distance:</span>
                  <span class="jensify-mileage-value">
                    {{ trip.distance_miles }} mi {{ trip.is_round_trip ? '(round trip)' : '' }}
                    @if (trip.distance_manually_modified) {
                      <mat-icon
                        class="distance-modified-icon"
                        matTooltip="Distance manually modified from {{ trip.original_gps_distance }} mi">
                        warning
                      </mat-icon>
                    }
                  </span>
                </div>
                <div class="jensify-mileage-item">
                  <span class="jensify-mileage-label">Total Miles:</span>
                  <span class="jensify-mileage-value">{{ trip.total_miles }} mi</span>
                </div>
                <div class="jensify-mileage-item">
                  <span class="jensify-mileage-label">IRS Rate:</span>
                  <span class="jensify-mileage-value">${{ trip.irs_rate.toFixed(3) }}/mi</span>
                </div>
              </div>

              @if (trip.notes) {
                <p class="jensify-trip-notes">{{ trip.notes }}</p>
              }
            </div>

            <!-- Reimbursement Amount -->
            <div class="jensify-trip-amount">
              <span class="jensify-amount-value">{{ formatCurrency(trip.reimbursement_amount) }}</span>
              <span class="jensify-amount-label">Reimbursement</span>
            </div>
          </div>

          <!-- Card Actions -->
          <div class="jensify-card-actions" role="group" [attr.aria-label]="'Actions for trip on ' + formatDate(trip.trip_date)">
            <button
              mat-button
              (click)="goToDetails(trip)"
              class="jensify-button"
              [attr.aria-label]="'View details for trip from ' + trip.origin_address + ' to ' + trip.destination_address">
              <mat-icon aria-hidden="true">visibility</mat-icon>
              Details
            </button>
            @if (canConvertToExpense(trip)) {
              <button
                mat-button
                color="accent"
                (click)="convertToExpense(trip)"
                class="jensify-button"
                [attr.aria-label]="'Convert this trip to an expense'">
                <mat-icon aria-hidden="true">receipt_long</mat-icon>
                To Expense
              </button>
            }
            @if (trip.expense_id) {
              <button
                mat-button
                (click)="viewLinkedExpense(trip)"
                class="jensify-button"
                [attr.aria-label]="'View linked expense for this trip'">
                <mat-icon aria-hidden="true">open_in_new</mat-icon>
                View Expense
              </button>
            }
            @if (trip.status === 'draft') {
              <button
                mat-button
                color="primary"
                (click)="goToEdit(trip)"
                class="jensify-button"
                [attr.aria-label]="'Edit this trip'">
                <mat-icon aria-hidden="true">edit</mat-icon>
                Edit
              </button>
              <button
                mat-button
                color="warn"
                (click)="deleteTrip(trip)"
                class="jensify-button"
                [attr.aria-label]="'Delete this trip'">
                <mat-icon aria-hidden="true">delete</mat-icon>
                Delete
              </button>
            }
          </div>
        </mat-card>
      </div>
    </cdk-virtual-scroll-viewport>
  }
</div>
